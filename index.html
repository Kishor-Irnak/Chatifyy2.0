<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat App with Edit/Delete & Profile Pictures</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      onChildChanged,
      onChildRemoved,
      update,
      remove,
      set
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    
    import {
      getStorage,
      ref as sRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCp3RanzzQ2lGf8HQ-XaGe_W1cuxZe0GVc",
      authDomain: "authentication-a95dc.firebaseapp.com",
      projectId: "authentication-a95dc",
      storageBucket: "authentication-a95dc.appspot.com",
      messagingSenderId: "263589613044",
      appId: "1:263589613044:web:4df90594ae765365a3bda1",
      measurementId: "G-21NE0GLRVY",
      databaseURL: "https://authentication-a95dc-default-rtdb.firebaseio.com/"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    
    let user = null;
    
    document.addEventListener("DOMContentLoaded", () => {
      const authPage = document.getElementById("auth-page");
      const loginPage = document.getElementById("login-page");
      const registerPage = document.getElementById("register-page");
      const chatPage = document.getElementById("chat-page");
      const messagesContainer = document.getElementById("messages");
    
      const sendBtn = document.getElementById("sendBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const fileInput = document.getElementById("fileInput");
      const typingStatus = document.getElementById("typingStatus");
    
      let typingTimeout;
    
      document.getElementById("goToLogin").addEventListener("click", () => {
        authPage.classList.add("hidden");
        loginPage.classList.remove("hidden");
      });
    
      document.getElementById("goToRegister").addEventListener("click", () => {
        authPage.classList.add("hidden");
        registerPage.classList.remove("hidden");
      });
    
      document.getElementById("registerBtn").addEventListener("click", () => {
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        createUserWithEmailAndPassword(auth, email, password)
          .then(() => {
            alert("Registered Successfully!");
            registerPage.classList.add("hidden");
            loginPage.classList.remove("hidden");
          })
          .catch(error => alert(error.message));
      });
    
      document.getElementById("loginBtn").addEventListener("click", () => {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        signInWithEmailAndPassword(auth, email, password)
          .then(result => {
            user = result.user;
            loginPage.classList.add("hidden");
            chatPage.classList.remove("hidden");
    
            // Save user status online
            set(ref(db, "typing/" + user.uid), {
              name: user.email,
              typing: false
            });
          })
          .catch(error => alert(error.message));
      });
    
      logoutBtn.addEventListener("click", () => {
        signOut(auth).then(() => {
          chatPage.classList.add("hidden");
          authPage.classList.remove("hidden");
        });
      });
    
      // Typing event
      const messageInput = document.getElementById("messageInput");
      messageInput.addEventListener("input", () => {
        clearTimeout(typingTimeout);
        set(ref(db, "typing/" + user.uid), { name: user.email, typing: true });
    
        typingTimeout = setTimeout(() => {
          set(ref(db, "typing/" + user.uid), { name: user.email, typing: false });
        }, 2000);
      });
    
      // Listen for typing
      onChildAdded(ref(db, "typing"), snap => {
        const typingUser = snap.val();
        if (typingUser.typing && typingUser.name !== user.email) {
          typingStatus.innerText = `${typingUser.name} is typing...`;
        }
      });
      onChildChanged(ref(db, "typing"), snap => {
        const typingUser = snap.val();
        if (!typingUser.typing) typingStatus.innerText = "";
      });
    
      sendBtn.addEventListener("click", () => {
        const message = messageInput.value;
        if (message.trim()) {
          push(ref(db, "messages"), {
            name: user.email,
            text: message,
            timestamp: Date.now(),
            seen: false,
            type: "text"
          });
          messageInput.value = "";
        }
      });
    
      fileInput.addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
    
        const storageReference = sRef(storage, `chat_files/${Date.now()}_${file.name}`);
    
        uploadBytes(storageReference, file).then(snapshot => {
          getDownloadURL(snapshot.ref).then(url => {
            push(ref(db, "messages"), {
              name: user.email,
              fileUrl: url,
              fileName: file.name,
              timestamp: Date.now(),
              seen: false,
              type: "file"
            });
          });
        });
      });
    
      // Render messages
      onChildAdded(ref(db, "messages"), snapshot => {
        const msg = snapshot.val();
        const key = snapshot.key;
        const msgElement = document.createElement("div");
        msgElement.className = "message border p-2 mb-2 rounded shadow";
    
        let content = `<strong>${msg.name}</strong>: `;
    
        if (msg.type === "text") {
          content += msg.text;
        } else if (msg.type === "file") {
          const isImage = /\.(jpg|jpeg|png|gif)$/i.test(msg.fileName);
          if (isImage) {
            content += `<img src="${msg.fileUrl}" alt="${msg.fileName}" class="w-32 h-32 object-cover mt-2" />`;
          } else {
            content += `<a href="${msg.fileUrl}" target="_blank" class="text-blue-500 underline">${msg.fileName}</a>`;
          }
        }
    
        content += `<br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
    
        // Add delete/edit buttons if sender is current user
        if (msg.name === user.email) {
          content += `
            <div class="flex gap-2 mt-2">
              <button onclick="editMessage('${key}', '${msg.text || ""}')">‚úèÔ∏è Edit</button>
              <button onclick="deleteMessage('${key}')">üóëÔ∏è Delete</button>
            </div>`;
        }
    
        msgElement.innerHTML = content;
        messagesContainer.appendChild(msgElement);
    
        // Notification if not focused
        if (document.visibilityState !== 'visible') {
          new Notification("New message from " + msg.name, {
            body: msg.type === "text" ? msg.text : msg.fileName,
            icon: "chat_icon.png" // optional icon URL
          });
        }
    
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    
      onChildChanged(ref(db, "messages"), snapshot => {
        const key = snapshot.key;
        const updatedMsg = snapshot.val();
    
        const messages = messagesContainer.querySelectorAll(".message");
        messages.forEach(msgDiv => {
          if (msgDiv.dataset.key === key) {
            msgDiv.querySelector("p").innerText = updatedMsg.text;
          }
        });
      });
    
      // Update seen
      onChildAdded(ref(db, "messages"), snapshot => {
        const key = snapshot.key;
        const msg = snapshot.val();
    
        if (!msg.seen && msg.name !== user.email) {
          update(ref(db, "messages/" + key), { seen: true });
        }
      });
    });
    
    // Edit Message (global so inline onclick works)
    window.editMessage = function (key, currentText) {
      const newText = prompt("Edit your message:", currentText);
      if (newText) {
        update(ref(db, "messages/" + key), { text: newText });
      }
    };
    
    // Delete Message (global so inline onclick works)
    window.deleteMessage = function (key) {
      if (confirm("Delete this message?")) {
        remove(ref(db, "messages/" + key));
      }
    };
    
    // Request Notification permission on page load
    document.addEventListener("DOMContentLoaded", () => {
      if (Notification.permission !== "granted") {
        Notification.requestPermission();
      }
    });
    </script>
</head>
<body class="flex items-center justify-center h-screen bg-gradient-to-r from-green-200 to-blue-300">
  <!-- Auth Landing -->
  <div id="auth-page" class="text-center bg-white p-8 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Welcome</h1>
    <button id="goToLogin" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Login</button>
    <button id="goToRegister" class="mt-4 px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600">Register</button>
  </div>

  <!-- Register -->
  <div id="register-page" class="hidden text-center bg-white p-8 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Register</h1>
    <input id="registerEmail" type="email" placeholder="Email" class="border p-2 mt-2 w-full rounded"/>
    <input id="registerPassword" type="password" placeholder="Password" class="border p-2 mt-2 w-full rounded"/>
    <input id="registerPhoto" type="text" placeholder="Profile Picture URL (optional)" class="border p-2 mt-2 w-full rounded"/>
    <button id="registerBtn" class="mt-4 px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600">Register</button>
  </div>

  <!-- Login -->
  <div id="login-page" class="hidden text-center bg-white p-8 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Login</h1>
    <input id="loginEmail" type="email" placeholder="Email" class="border p-2 mt-2 w-full rounded"/>
    <input id="loginPassword" type="password" placeholder="Password" class="border p-2 mt-2 w-full rounded"/>
    <button id="loginBtn" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Login</button>
  </div>

  <!-- Chat -->
  <div id="chat-page" class="hidden w-full max-w-md bg-white p-4 shadow-lg rounded">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-xl font-semibold">Chat Room</h2>
      <div id="typingStatus" class="text-sm text-gray-500"></div>

      <button id="logoutBtn" class="px-4 py-1 bg-red-500 text-white rounded hover:bg-red-600">Logout</button>
    </div>
    <div id="messages" class="h-64 overflow-y-auto p-2 border rounded mb-2 bg-gray-50"></div>
    <div id="typingStatus" class="text-xs text-gray-500 mb-2"></div>
    <div class="flex gap-2">
        <input type="file" id="fileInput" class="hidden">
<button onclick="document.getElementById('fileInput').click()">üìé Attach</button>

      <input id="messageInput" type="text" placeholder="Type a message..." class="flex-1 p-2 border rounded"/>
      <button id="sendBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Send</button>
    </div>
  </div>
</body>
</html>
